use pandas UDFs with batch processing for better performance